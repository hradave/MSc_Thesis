library(pROC)
library(ggplot2)
library(caret)
library(ModelMetrics)


#######################################################################################
#                                          SMALL
#######################################################################################

slide_labels = c(rep(1,42), rep(0,42))

#################   resnet_block4_IN_weights3 - small

majvote = c(0.9670691547749726, 0.9687800192122958, 0.9923371647509579, 0.9933875890132248, 0.9910371318822023, 0.9955307262569832, 0.9973285841495992, 0.9735294117647059, 1.0, 1.0, 0.9157303370786517, 0.9615508885298869, 0.9833333333333333, 0.9365846919038409, 0.9934640522875817, 0.9788121454788121, 0.889426399447132, 0.8849283223556761, 1.0, 0.9994378864530635, 0.7026627218934911, 0.7665087768180552, 0.9909735654416505, 1.0, 1.0, 0.9995766299745978, 1.0, 0.9961059190031153, 0.995617110799439, 0.9968061322261258, 0.8018129377832716, 0.997789240972734, 0.9988482579902102, 0.9988518943742825, 0.9983072365636902, 0.9971364937957365, 1.0, 0.9741593685803871, 0.5763428991905812, 0.88264192139738, 0.8137535816618912, 0.8683274021352313, 0.1295512277730737, 0.08192090395480223, 0.5361341298901523, 0.01963316972358564, 0.04258241758241754, 0.18860551213492394, 0.39562624254473167, 0.10236220472440949, 0.8379888268156425, 0.03968253968253965, 0.9232673267326733, 0.16945107398568016, 0.1893165750196386, 0.0433175939232191, 0.005474452554744547, 0.015879562796452862, 0.02503148614609574, 0.01694573330643534, 0.0028186658315064728, 0.1615027110766848, 0.006110558476623562, 0.002540892488486546, 0.0016703786191536452, 0.04513773647527386, 0.0068889501240011475, 0.29546695794647737, 0.0002180549498473905, 0.012825994014536102, 0.010310965630114577, 0.019465934614424807, 0.050987675164612556, 0.16740646797717185, 0.5406945198046663, 0.03974261922785771, 0.4125087027152472, 0.12988905076767898, 0.03330790744978385, 0.1837073981712386, 0.6640253565768621, 0.8626993387786853, 0.03007518796992481, 0.5221799746514575)
weighted_MIL = c(0.9638063137010561, 0.969730398421328, 0.9920638591424297, 0.9942793836128595, 0.9874650713909721, 0.994871189228673, 0.996021590802628, 0.9665491626227267, 0.9997978105801407, 0.9974420836181563, 0.90630309633745, 0.965733021254934, 0.9804568119435669, 0.9430066723916478, 0.9898961301764094, 0.9749086444224682, 0.8979815527420704, 0.8878462412214406, 0.9995186608121852, 0.9993523853929466, 0.6802418145301684, 0.7805126148286068, 0.986269281556907, 0.999978524764584, 0.9998479086141339, 0.999408175879943, 0.9998690770616873, 0.9969115216377528, 0.9964070874365805, 0.9966681619242582, 0.8066820567529609, 0.9972603382176188, 0.9986115944200795, 0.9984317431256468, 0.9981537427394047, 0.9973889568072589, 0.999407300564298, 0.9748408136402184, 0.5852952782912477, 0.8919666950234421, 0.8195298505264798, 0.8569039619186198, 0.13739156278346776, 0.07087313064068666, 0.5144607380571223, 0.016922412526669765, 0.03557834762312704, 0.1780748090622387, 0.434928935547809, 0.09993449968037357, 0.8419936300811732, 0.04589309681711178, 0.9271724682244442, 0.17188018136359293, 0.18155523574617813, 0.04446953670341218, 0.005691726365182007, 0.014517911109257127, 0.02432089070200035, 0.016392106891514234, 0.0024254253312941806, 0.15615710349266987, 0.00514028622634885, 0.004009610534772444, 0.0016742561920646813, 0.04556337084420981, 0.0065754154190001066, 0.28006874546009086, 0.0005175236238399156, 0.01456419377282819, 0.011578346489066775, 0.01814403292466179, 0.04674593102709769, 0.15788070321557626, 0.5547994249217191, 0.02971967359048675, 0.3942939770151452, 0.1341424750916127, 0.03189908628351504, 0.1782907257824166, 0.6530072153496052, 0.8719396139032963, 0.0314715611915774, 0.5142663143899823)
logreg = c(0.8858711118644882, 0.9345700051905356, 0.9575814815828548, 0.9601767688828019, 0.9393978765047117, 0.9591449019796068, 0.9605826788105595, 0.8934976328996482, 0.9679564710808398, 0.9615187087163773, 0.6180199124694487, 0.9173571279482481, 0.9332855565797266, 0.8888029135762742, 0.9411710767719269, 0.9248812641348497, 0.7924462766727535, 0.6383370208512549, 0.9649371631245347, 0.9664303784649096, 0.028147042918728882, 0.3010150984316137, 0.928616879259932, 0.967873559542804, 0.9670810931710416, 0.9670778098239462, 0.96736774399816, 0.964745239232305, 0.9648632850076436, 0.9611832005119392, 0.28130770365827307, 0.9643015696514968, 0.9661015652544248, 0.96536709108784, 0.9658532154064488, 0.9628409473408432, 0.9665234624275855, 0.9357306248301881, 0.038749447138924926, 0.8102427940716945, 0.3682240085887719, 0.30082818569831477, 0.00020042525028291286, 3.5853519295371885e-05, 0.008445726891450674, 1.0071884443783321e-05, 1.5663164981367817e-05, 0.00016491252695093617, 0.014520767429624484, 6.529231550384081e-05, 0.38743371400207705, 1.9807218827496188e-05, 0.7161111996397911, 0.00021915663529310458, 0.00024990566403270016, 2.303305254490676e-05, 7.52926367557321e-06, 1.0829526172504802e-05, 1.1975285555591444e-05, 9.631737123274076e-06, 6.764455583841108e-06, 0.0001594277002686897, 7.085493113210681e-06, 7.903307674553873e-06, 6.6237737736362484e-06, 1.7098556625907175e-05, 7.896135579661254e-06, 0.0006130231990982339, 6.472623045515405e-06, 1.0388827657579156e-05, 9.923742096932114e-06, 9.637750138241206e-06, 2.4995402865724888e-05, 0.0002579577561685795, 0.02661543216945156, 1.857825495799216e-05, 0.002905326806166791, 0.00015601252574332601, 2.0135109412445558e-05, 0.00020736391719731334, 0.03160463055956328, 0.47829308476769733, 2.148323498427569e-05, 0.012465107372154885)
pathologist = c(1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.999952, 0.9999866, 1.0, 1.0, 0.9999407, 1.0, 0.99897134, 1.0, 0.9999997, 1.0, 1.0, 0.99704856, 0.99999875, 0.9999962, 0.99999976, 0.9978945, 1.0, 0.99999964, 0.9999798, 0.9832325, 1.0, 0.99993247, 1.0, 0.7076008, 1.0, 0.99992996, 1.0, 1.0, 1.0, 1.0, 0.9998611, 1.0, 1.0, 0.9999942, 1.0, 1.0, 1.0, 0.9720083, 1.0)
flipping = c(0.9740944017563118, 0.9702209414024976, 0.9940400170285227, 0.9966937945066124, 0.9948783610755442, 0.9966480446927374, 0.9982190560997328, 0.9823529411764705, 1.0, 1.0, 0.9221508828250401, 0.9634894991922456, 0.9860696517412936, 0.9386570875932578, 1.0, 0.9828161494828161, 0.8921907394609537, 0.8899651297946533, 1.0, 0.9994378864530635, 0.7263313609467456, 0.7729172471440513, 0.996776273372018, 1.0, 1.0, 0.9995766299745978, 1.0, 0.9966251298026999, 0.9970196353436185, 0.9993612264452252, 0.8090234857849197, 0.9992630803242447, 0.9990402149918418, 1.0, 0.9985893638030752, 0.9987273305758829, 1.0, 0.977186722888961, 0.5768947755702722, 0.8837336244541485, 0.816857688634193, 0.8861209964412812, 0.11515664690939886, 0.07450564971751417, 0.5351705530930815, 0.016274864376130238, 0.03944270015698592, 0.18675442204853965, 0.3936381709741551, 0.10236220472440949, 0.8547486033519553, 0.03968253968253965, 0.9232673267326733, 0.16706443914081148, 0.18146111547525534, 0.038801067542599044, 0.0036496350364964014, 0.010311404413281045, 0.02298488664987408, 0.014726649182973617, 0.0009395552771688243, 0.15685515104570102, 0.0048316043768651395, 0.0011116404637129262, 0.000556792873051215, 0.04115499502157316, 0.004271149076880643, 0.2949208083014746, 0.0, 0.010047028644719957, 0.00621931260229136, 0.01846768155727474, 0.043559007259834526, 0.16148805749313044, 0.5417797069994574, 0.03141559424678275, 0.4125087027152472, 0.12383727445926263, 0.023900330536486103, 0.17844278193405372, 0.6664025356576861, 0.8681446907817969, 0.018796992481203034, 0.5204900718208703)

roca1 = roc(slide_labels, majvote)
rocb1 = roc(slide_labels, weighted_MIL)
rocc1 = roc(slide_labels, logreg)
rocd1 = roc(slide_labels, pathologist)
roce1 = roc(slide_labels, flipping)

colours = c("#1F77B4","#FF7F0E", "#2CA02C", "#8C564B", "#FFD700")
graph = ggroc(list("Majority voting (AUC = 0.9881)" = roca1, 
                   "Weighted MIL (AUC = 0.9875)" = rocb1, 
                   "Logistic regression (AUC = 0.9881)" = rocc1,
                   "Pathologist's (AUC = 0.7262)" = rocd1,
                   "Spatial smoothing (AUC = 0.9881)" = roce1),
              aes = c("colour"),
              size = 1) + 
  theme(legend.title=element_blank()) +
  scale_color_manual(values = colours)+ 
  theme(legend.position='none')

graph

name = "small_slide_roc"
graph + ggsave(paste0(name,".png"), type = "cairo")

# test
roc.test(roca1, rocb1, method = "delong")
roc.test(roca1, rocc1, method = "delong")
roc.test(roca1, rocd1, method = "delong")
roc.test(roca1, roce1, method = "delong")
roc.test(rocb1, rocc1, method = "delong")
roc.test(rocb1, rocd1, method = "delong")
roc.test(rocb1, roce1, method = "delong")
roc.test(rocc1, rocd1, method = "delong")
roc.test(rocc1, roce1, method = "delong")
roc.test(rocd1, roce1, method = "delong")

# confusion matrix
best = majvote
confusionMatrix(slide_labels, best)

# metrics
precision = caret::posPredValue(as.factor(round(best)), as.factor(slide_labels), positive = "1") #0.8571429
recall = caret::sensitivity(as.factor(round(best)), as.factor(slide_labels), positive="1") #1
F1 = (2 * precision * recall) / (precision + recall) #0.9230769

# accuracy
sum(diag(ModelMetrics::confusionMatrix(slide_labels, majvote))) / length(slide_labels) #0.9166667
sum(diag(ModelMetrics::confusionMatrix(slide_labels, weighted_MIL))) / length(slide_labels) #0.9166667
sum(diag(ModelMetrics::confusionMatrix(slide_labels, logreg))) / length(slide_labels) #0.9166667
sum(diag(ModelMetrics::confusionMatrix(slide_labels, pathologist))) / length(slide_labels) #0.5
sum(diag(ModelMetrics::confusionMatrix(slide_labels, flipping))) / length(slide_labels) #0.9166667

# power test (twice as many slides)
slide_labels = c(slide_labels, slide_labels)
majvote = c(majvote, majvote)
weighted_MIL = c(weighted_MIL, weighted_MIL)
logreg = c(logreg, logreg)
pathologist = c(pathologist, pathologist)
flipping = c(flipping, flipping)

p_values = rep(0,10)
p_values[1] = roc.test(roca1, rocb1, method = "delong")$p.value
p_values[2] = roc.test(roca1, rocc1, method = "delong")$p.value
p_values[3] = roc.test(roca1, rocd1, method = "delong")$p.value
p_values[4] = roc.test(roca1, roce1, method = "delong")$p.value
p_values[5] = roc.test(rocb1, rocc1, method = "delong")$p.value
p_values[6] = roc.test(rocb1, rocd1, method = "delong")$p.value
p_values[7] = roc.test(rocb1, roce1, method = "delong")$p.value
p_values[8] = roc.test(rocc1, rocd1, method = "delong")$p.value
p_values[9] = roc.test(rocc1, roce1, method = "delong")$p.value
p_values[10] = roc.test(rocd1, roce1, method = "delong")$p.value

p_values_small8 = p_values
p_values_small1
p_values_small2
p_values_small4
p_values_small8

#######################################################################################
#                                          MEDIUM
#######################################################################################

slide_labels = c(rep(1,42), rep(0,42))

############ resnet_block4_IN_weights3_2 - medium

majvote = c(0.948432760364004, 0.9504504504504504, 0.9771863117870723, 0.9288214702450408, 0.9485294117647058, 0.975, 0.8922413793103449, 0.9153846153846154, 0.8269230769230769, 0.9743589743589743, 0.9588014981273408, 0.7905544147843943, 0.9654017857142857, 0.9609644087256027, 0.9137931034482758, 0.8255707762557077, 0.8717105263157895, 0.9521367521367521, 1.0, 0.9946949602122016, 0.9206349206349207, 0.92, 0.9933993399339934, 0.9892116182572614, 0.9974337040205303, 0.9585439838220424, 0.9745098039215686, 0.9811320754716981, 0.9887096774193549, 0.9938744257274119, 0.45971428571428574, 0.9962894248608535, 0.9974025974025974, 0.9929078014184397, 0.989769820971867, 0.9010654490106544, 1.0, 0.9855140186915888, 0.45972335231895856, 0.7694300518134716, 0.9150259067357513, 0.8242811501597445, 0.47777777777777775, 0.01754385964912286, 0.42145270270270274, 0.0021739130434782483, 0.057094878253568404, 0.24978466838931956, 0.961038961038961, 0.017241379310344862, 0.6216216216216216, 0.0, 0.8266666666666667, 0.0625, 0.24489795918367352, 0.053494391716997436, 0.024691358024691357, 0.20778072502210432, 0.0013477088948786742, 0.059534081104400394, 0.0013386880856760541, 0.17964071856287422, 0.012077294685990392, 0.05292096219931275, 0.0024360535931789995, 0.099290780141844, 0.025581395348837188, 0.6200527704485488, 0.006392694063926951, 0.036310107948969605, 0.027181688125894166, 0.013392857142857095, 0.06278026905829592, 0.2941729323308271, 0.9644549763033176, 0.0016666666666667052, 0.33827042522694695, 0.09695550351288051, 0.010976948408342513, 0.4507772020725389, 0.3704545454545455, 0.16161616161616166, 0.021739130434782594, 0.797153024911032)
weighted_MIL = c(0.9457759699929955, 0.9476562353039907, 0.9738621449316796, 0.9352751019737024, 0.9356840670754409, 0.9778010749086141, 0.9030825843951068, 0.9067106579610981, 0.8147514264112157, 0.9782206332659803, 0.9561750657183419, 0.7960771692429666, 0.9549945370996417, 0.9645209970931399, 0.8982064251612347, 0.8731590659771462, 0.8783375795024917, 0.9408419229668971, 0.9965380289717127, 0.9941850664872017, 0.8698004608764109, 0.9153885033069491, 0.9882769945204025, 0.986382266463018, 0.9941434074968692, 0.9540973420467638, 0.9708062483022548, 0.9851433559044971, 0.9882807326375985, 0.9921519760359944, 0.4474215461460391, 0.9903980647480845, 0.9920991368834977, 0.9937403935635113, 0.9831747628241618, 0.9048098217620514, 0.9880238327726966, 0.9851496731809698, 0.4574557008622904, 0.7645688477486833, 0.9177853416026879, 0.7954981084187237, 0.478308011511175, 0.024666509940241933, 0.40195871421059826, 0.0026431681916812056, 0.049668279903809655, 0.24855235776477183, 0.9385292156834377, 0.07134964203973833, 0.6667103717924796, 0.006672963469281044, 0.8694509642195993, 0.056730207979431, 0.22923815042984158, 0.05814437994443834, 0.03433354636847445, 0.1882454593806918, 0.0014563041778962072, 0.06601482128347912, 0.001962862582997876, 0.17325198702759637, 0.01051363143093577, 0.05999089795482465, 0.002881244806729025, 0.08977997687153179, 0.03495820043175302, 0.6202745240258737, 0.01055960540326325, 0.03793804548373772, 0.03288024099776342, 0.01185779449980827, 0.05837519444703022, 0.27612266486965464, 0.9535604674814665, 0.005175859322139443, 0.3295511915609373, 0.10292573715774152, 0.018427413941531072, 0.46741046350867976, 0.35270305580102795, 0.1745254929733388, 0.019980626292192633, 0.786416869815883)
logreg = c(0.9495988235726521, 0.9727960488924782, 0.9805346807472429, 0.9390868827383974, 0.91632961055164, 0.9845023441395249, 0.9235489702160339, 0.8665947587828282, 0.8010404121515007, 0.9795703139887423, 0.9574415021686107, 0.7586238622752446, 0.9566443697514989, 0.9759757949154976, 0.9356665407231126, 0.9116699048552007, 0.9446158226500088, 0.9538420058396772, 0.9872864413983963, 0.9862406535883016, 0.7263349846245235, 0.9175834522943521, 0.98245112022031, 0.98331014058246, 0.9873930708387029, 0.9619943570989073, 0.972604775412347, 0.9867816760465009, 0.9857175947680082, 0.9869479966486675, 0.09709905207932067, 0.9865214797759786, 0.9861322724537075, 0.988653898871058, 0.9785038700490734, 0.9360837650462775, 0.981904805870836, 0.9852538219029673, 0.15064996589919413, 0.7401705718024232, 0.9452452680447792, 0.4971515905147856, 0.19343671105871998, 0.0010373850053769164, 0.09425284916841697, 0.0004021850347193149, 0.0008791875657132002, 0.02496169630090457, 0.9362520333507446, 0.009640242740845063, 0.7702066351352271, 0.0006155161533004003, 0.9170909986635399, 0.0006967744174973811, 0.027115822891994316, 0.0016201081321432697, 0.0012280012526394816, 0.005130541141580586, 0.00038377775690811975, 0.0023511850884695546, 0.0004116052517672368, 0.01046687517297613, 0.0005047518107183904, 0.0025746401405275666, 0.00043051377220665516, 0.0022687470660738784, 0.001521784819318254, 0.3701330121586505, 0.0005845691655841753, 0.0012296373235755739, 0.0012817594534359344, 0.000502472627819127, 0.0014972614810048422, 0.03039807082792857, 0.9564359408269688, 0.00048642735409005437, 0.041091966375116695, 0.00428236311598866, 0.0007642987039355733, 0.1691959940341568, 0.04210129975486802, 0.008489123254156322, 0.0007431710039149053, 0.5600791907605543)
pathologist = c(1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.9999998, 0.99999946, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.99999434, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.9999998, 1.0, 1.0, 1.0, 0.9999754, 0.98420984, 1.0, 0.7609622, 0.9999974, 1.0, 0.99999946, 0.63326746, 1.0, 0.11103717, 1.0, 0.9962816, 0.99933445, 1.0, 0.53711057, 0.9999748, 0.9126476, 0.99879456, 0.50179476, 0.99991435, 0.99999756, 0.9970396, 0.8115216, 0.99990815, 0.9960803, 1.0, 0.902382, 0.99759036, 0.99973214, 0.9786642, 0.999947, 1.0, 1.0, 0.6466981, 1.0, 0.9999998, 0.99946576, 1.0, 0.9999999, 0.99999934, 0.6807225, 0.99999994)
flipping = c(0.9737108190091001, 0.954954954954955, 0.9838403041825095, 0.9334889148191365, 0.9485294117647058, 0.975, 0.9310344827586207, 0.9384615384615385, 0.8269230769230769, 1.0, 0.9775280898876404, 0.7905544147843943, 0.9709821428571429, 0.9626865671641791, 0.9137931034482758, 0.8356164383561644, 0.8782894736842105, 0.9641025641025641, 1.0, 1.0, 0.9523809523809523, 0.9316129032258065, 1.0, 0.9966804979253112, 0.9991445680068435, 0.967644084934277, 0.9980392156862745, 0.9823899371069182, 0.9919354838709677, 0.996937212863706, 0.45485714285714285, 0.9962894248608535, 0.9978354978354979, 1.0, 0.9916879795396419, 0.91324200913242, 1.0, 0.9883177570093458, 0.45972335231895856, 0.772020725388601, 0.9264248704663213, 0.8466453674121406, 0.4722222222222222, 0.01594896331738438, 0.41216216216216217, 0.0, 0.055415617128463435, 0.24289405684754517, 0.961038961038961, 0.0, 0.6216216216216216, 0.0, 0.8666666666666667, 0.0625, 0.23469387755102045, 0.049180327868852514, 0.024691358024691357, 0.20512820512820518, 0.0006738544474393926, 0.05522001725625536, 0.0, 0.16367265469061876, 0.009057971014492794, 0.043298969072164906, 0.0, 0.09432624113475174, 0.01918604651162792, 0.6200527704485488, 0.005479452054794498, 0.027477919528949957, 0.012875536480686733, 0.004464285714285698, 0.05082212257100149, 0.2951127819548872, 0.9727488151658767, 0.0008333333333333526, 0.3368370759675108, 0.09508196721311479, 0.00658616904500553, 0.4507772020725389, 0.36704545454545456, 0.1575757575757576, 0.0, 0.806049822064057)

roca2 = roc(slide_labels, majvote)
rocb2 = roc(slide_labels, weighted_MIL)
rocc2 = roc(slide_labels, logreg)
rocd2 = roc(slide_labels, pathologist)
roce2 = roc(slide_labels, flipping)

colours = c("#1F77B4","#FF7F0E", "#2CA02C", "#8C564B", "#FFD700")
graph = ggroc(list("Majority voting" = roca2, 
                   "Weighted collective MIL" = rocb2, 
                   "Logistic regression" = rocc2,
                   "Standard MIL" = rocd2,
                   "Spatial smoothing" = roce2),
              aes = c("colour"),
              size = 1) + 
  theme(legend.title=element_blank()) +
  scale_color_manual(values = colours)+ 
  #theme(legend.text = element_text(size=15))+
  theme(legend.position='none')

graph

name = "medium_slide_roc"
graph + ggsave(paste0(name,".png"), type = "cairo")

# test
roc.test(roca2, rocb2, method = "delong")
roc.test(roca2, rocc2, method = "delong")
roc.test(roca2, rocd2, method = "delong")
roc.test(roca2, roce2, method = "delong")
roc.test(rocb2, rocc2, method = "delong")
roc.test(rocb2, rocd2, method = "delong")
roc.test(rocb2, roce2, method = "delong")
roc.test(rocc2, rocd2, method = "delong")
roc.test(rocc2, roce2, method = "delong")
roc.test(rocd2, roce2, method = "delong")


# accuracy
sum(diag(ModelMetrics::confusionMatrix(slide_labels, majvote))) / length(slide_labels) #0.9047619
sum(diag(ModelMetrics::confusionMatrix(slide_labels, weighted_MIL))) / length(slide_labels) #0.9047619
sum(diag(ModelMetrics::confusionMatrix(slide_labels, logreg))) / length(slide_labels) #0.9047619
sum(diag(ModelMetrics::confusionMatrix(slide_labels, pathologist))) / length(slide_labels) #0.5119048
sum(diag(ModelMetrics::confusionMatrix(slide_labels, flipping))) / length(slide_labels) #0.9047619


roc.test(roca1, roca2, method = "delong")
roc.test(roca1, rocb2, method = "delong")
roc.test(roca1, rocc2, method = "delong")
roc.test(roca1, rocd2, method = "delong")
roc.test(roca1, roce2, method = "delong")

roc.test(rocb1, roca2, method = "delong")
roc.test(rocb1, rocb2, method = "delong")
roc.test(rocb1, rocc2, method = "delong")
roc.test(rocb1, rocd2, method = "delong")
roc.test(rocb1, roce2, method = "delong")

roc.test(rocc1, roca2, method = "delong")
roc.test(rocc1, rocb2, method = "delong")
roc.test(rocc1, rocc2, method = "delong")
roc.test(rocc1, rocd2, method = "delong")
roc.test(rocc1, roce2, method = "delong")

roc.test(rocd1, roca2, method = "delong")
roc.test(rocd1, rocb2, method = "delong")
roc.test(rocd1, rocc2, method = "delong")
roc.test(rocd1, rocd2, method = "delong")
roc.test(rocd1, roce2, method = "delong")

roc.test(roce1, roca2, method = "delong")
roc.test(roce1, rocb2, method = "delong")
roc.test(roce1, rocc2, method = "delong")
roc.test(roce1, rocd2, method = "delong")
roc.test(roce1, roce2, method = "delong")


# confusion matrix
best = weighted_MIL
confusionMatrix(slide_labels, best)


# metrics
precision = caret::posPredValue(as.factor(round(best)), as.factor(slide_labels), positive = "1") #0.8695652
recall = caret::sensitivity(as.factor(round(best)), as.factor(slide_labels), positive="1") #0.952381
F1 = (2 * precision * recall) / (precision + recall) #0.9090909

# power test (twice as many slides)
slide_labels = c(slide_labels, slide_labels)
majvote = c(majvote, majvote)
weighted_MIL = c(weighted_MIL, weighted_MIL)
logreg = c(logreg, logreg)
pathologist = c(pathologist, pathologist)
flipping = c(flipping, flipping)



##############################  compare 2 best from each patch size (power test)

slide_labels = c(rep(1,42), rep(0,42))

#   resnet_block4_IN_weights3 - small
majvote = c(0.9670691547749726, 0.9687800192122958, 0.9923371647509579, 0.9933875890132248, 0.9910371318822023, 0.9955307262569832, 0.9973285841495992, 0.9735294117647059, 1.0, 1.0, 0.9157303370786517, 0.9615508885298869, 0.9833333333333333, 0.9365846919038409, 0.9934640522875817, 0.9788121454788121, 0.889426399447132, 0.8849283223556761, 1.0, 0.9994378864530635, 0.7026627218934911, 0.7665087768180552, 0.9909735654416505, 1.0, 1.0, 0.9995766299745978, 1.0, 0.9961059190031153, 0.995617110799439, 0.9968061322261258, 0.8018129377832716, 0.997789240972734, 0.9988482579902102, 0.9988518943742825, 0.9983072365636902, 0.9971364937957365, 1.0, 0.9741593685803871, 0.5763428991905812, 0.88264192139738, 0.8137535816618912, 0.8683274021352313, 0.1295512277730737, 0.08192090395480223, 0.5361341298901523, 0.01963316972358564, 0.04258241758241754, 0.18860551213492394, 0.39562624254473167, 0.10236220472440949, 0.8379888268156425, 0.03968253968253965, 0.9232673267326733, 0.16945107398568016, 0.1893165750196386, 0.0433175939232191, 0.005474452554744547, 0.015879562796452862, 0.02503148614609574, 0.01694573330643534, 0.0028186658315064728, 0.1615027110766848, 0.006110558476623562, 0.002540892488486546, 0.0016703786191536452, 0.04513773647527386, 0.0068889501240011475, 0.29546695794647737, 0.0002180549498473905, 0.012825994014536102, 0.010310965630114577, 0.019465934614424807, 0.050987675164612556, 0.16740646797717185, 0.5406945198046663, 0.03974261922785771, 0.4125087027152472, 0.12988905076767898, 0.03330790744978385, 0.1837073981712386, 0.6640253565768621, 0.8626993387786853, 0.03007518796992481, 0.5221799746514575)


# resnet_block4_IN_weights3_2 - medium
weighted_MIL = c(0.9457759699929955, 0.9476562353039907, 0.9738621449316796, 0.9352751019737024, 0.9356840670754409, 0.9778010749086141, 0.9030825843951068, 0.9067106579610981, 0.8147514264112157, 0.9782206332659803, 0.9561750657183419, 0.7960771692429666, 0.9549945370996417, 0.9645209970931399, 0.8982064251612347, 0.8731590659771462, 0.8783375795024917, 0.9408419229668971, 0.9965380289717127, 0.9941850664872017, 0.8698004608764109, 0.9153885033069491, 0.9882769945204025, 0.986382266463018, 0.9941434074968692, 0.9540973420467638, 0.9708062483022548, 0.9851433559044971, 0.9882807326375985, 0.9921519760359944, 0.4474215461460391, 0.9903980647480845, 0.9920991368834977, 0.9937403935635113, 0.9831747628241618, 0.9048098217620514, 0.9880238327726966, 0.9851496731809698, 0.4574557008622904, 0.7645688477486833, 0.9177853416026879, 0.7954981084187237, 0.478308011511175, 0.024666509940241933, 0.40195871421059826, 0.0026431681916812056, 0.049668279903809655, 0.24855235776477183, 0.9385292156834377, 0.07134964203973833, 0.6667103717924796, 0.006672963469281044, 0.8694509642195993, 0.056730207979431, 0.22923815042984158, 0.05814437994443834, 0.03433354636847445, 0.1882454593806918, 0.0014563041778962072, 0.06601482128347912, 0.001962862582997876, 0.17325198702759637, 0.01051363143093577, 0.05999089795482465, 0.002881244806729025, 0.08977997687153179, 0.03495820043175302, 0.6202745240258737, 0.01055960540326325, 0.03793804548373772, 0.03288024099776342, 0.01185779449980827, 0.05837519444703022, 0.27612266486965464, 0.9535604674814665, 0.005175859322139443, 0.3295511915609373, 0.10292573715774152, 0.018427413941531072, 0.46741046350867976, 0.35270305580102795, 0.1745254929733388, 0.019980626292192633, 0.786416869815883)


max_replica = 16
p_values_patch_sizes = rep(0,max_replica)
for (replica in c(1:max_replica)) {
  slide_labels_replica = rep(slide_labels, replica)
  majvote_replica = rep(majvote, replica)
  weighted_MIL_replica = rep(weighted_MIL, replica)
  
  roca1 = roc(slide_labels_replica, majvote_replica)
  rocb2 = roc(slide_labels_replica, weighted_MIL_replica)
  
  print(roca1$auc)
  print(rocb2$auc)
  
  p_values_patch_sizes[replica] = roc.test(roca1, rocb2, method = "delong")$p.value
}

df = data.frame(x = c(1:max_replica)*84, y = p_values_patch_sizes)
plot(p_values_patch_sizes)

p = ggplot(data = df, aes(x = x, y = y)) +
  geom_line(size = 1) + 
  scale_x_continuous(breaks = round(seq(100, max(df$x), by = 150))) +
  #xlim(84,max_replica*84) +
  geom_line(aes(y=0.05),linetype="dashed") + 
  #geom_hline(yintercept = 0.05) +
  scale_color_brewer(palette="Set1") + 
  #scale_color_manual(values = colours) + 
  xlab("Number of test slides") + ylab("p-value") + 
  #theme(legend.title = element_blank()) +
  #theme(legend.position = c(0.8, 0.5)) +
  #theme(axis.title=element_text(size=17)) + 
  theme(legend.position='none')
p
name = "power_test_simple"
p + ggsave(paste0(name,".png"), type = "cairo")

# 3-times replication is enough to make the difference significant at 0.05 (252 test slides)




######################################## PROPER POWER TEST ##################################################
roc.test(rocb2, roca1, method = "delong") #0.2537

power.roc.test(roca1, rocb2,alternative = "two.sided",
               power = 0.8, #0.5934056
               methods = "delong")




power_levels = seq(0.2, 0.99, 0.01)
sign_levels = c(0.01, 0.05, 0.1)
p_values_patch_sizes = matrix(nrow = length(power_levels), ncol = length(sign_levels))

for (sign_level in c(1:length(sign_levels))) {
  for (power_level in c(1:length(power_levels))) {
    ptest = power.roc.test(roca1, rocb2, alternative = "two.sided",
                           power = power_levels[power_level], #0.5934056
                           sig.level = sign_levels[sign_level],
                           methods = "delong")
    p_values_patch_sizes[power_level,sign_level] = ptest$ncases + ptest$ncontrols
  }
  
}


plot(power_levels, p_values_patch_sizes[,1], type = 'l')
lines(power_levels, p_values_patch_sizes[,2])
lines(power_levels, p_values_patch_sizes[,3])

df_a = data.frame(x = power_levels, y = p_values_patch_sizes[,1])
df_b = data.frame(x = power_levels, y = p_values_patch_sizes[,2])
df_c = data.frame(x = power_levels, y = p_values_patch_sizes[,3])
df = rbind(df_a, df_b, df_c)
df$sig.level <- c(rep("0.01", nrow(df_a)), 
                rep("0.05", nrow(df_b)),
                rep("0.1", nrow(df_c)))

colours = c("#1F77B4","#FF7F0E", "#2CA02C")
p = ggplot(data = df, aes(x = x, y = y, col=sig.level)) +
  #ylim(NA,1) +
  geom_line(size = 1) + 
  #scale_color_brewer(palette="Set1") + 
  scale_color_manual(values = colours) + 
  #geom_line(aes(x=0.8),linetype="dashed", col = "black") +
  xlab("Power") + ylab("Sample size") + 
  #theme(legend.title = element_blank()) +
  #theme(legend.position = c(0.8, 0.5)) +
  theme(axis.title=element_text(size=12)) +
  theme(legend.text = element_text(size=12))
  #theme(legend.position='none')
p
name = "power_test"
p + ggsave(paste0(name,".png"), type = "cairo")
